cscope 15 /afs/cs.wisc.edu/p/course/cs537-yuvraj/private/CS537-SP21-Archive/projects/p7-web-server/start-code -q 0000000279 0000019264
	@client.c

24 
	~"h–³r.h
"

29 
	$ş›ÁS’d
(
fd
, *
f’ame
)

31 
buf
[
MAXLINE
];

32 
ho¡Çme
[
MAXLINE
];

34 
	`G‘ho¡Çme
(
ho¡Çme
, 
MAXLINE
);

37 
	`¥rštf
(
buf
, "GET % HTTP/1.1\n", 
f’ame
);

38 
	`¥rštf
(
buf
, "%sho¡: %s\n\r\n", buf, 
ho¡Çme
);

39 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

40 
	}
}

45 
	$ş›ÁPršt
(
fd
)

47 
rio_t
 
rio
;

48 
buf
[
MAXBUF
];

49 
Ëngth
 = 0;

50 
n
;

52 
	`Rio_»adš™b
(&
rio
, 
fd
);

55 
n
 = 
	`Rio_»adlšeb
(&
rio
, 
buf
, 
MAXBUF
);

56 
	`¡rcmp
(
buf
, "\r\n"è&& (
n
 > 0)) {

57 
	`´štf
("H—d”: %s", 
buf
);

58 
n
 = 
	`Rio_»adlšeb
(&
rio
, 
buf
, 
MAXBUF
);

61 ià(
	`ssÿnf
(
buf
, "CÚ‹Á-L’gth: %d ", &
Ëngth
) == 1) {

62 
	`´štf
("L’gth = %d\n", 
Ëngth
);

67 
n
 = 
	`Rio_»adlšeb
(&
rio
, 
buf
, 
MAXBUF
);

68 
n
 > 0) {

69 
	`´štf
("%s", 
buf
);

70 
n
 = 
	`Rio_»adlšeb
(&
rio
, 
buf
, 
MAXBUF
);

72 
	}
}

74 
	$maš
(
¬gc
, *
¬gv
[])

76 *
ho¡
, *
f’ame
;

77 
pÜt
;

78 
ş›Áfd
;

80 ià(
¬gc
 != 4) {

81 
	`årštf
(
¡d”r
, "U§ge: % <ho¡> <pÜt> <f’ame>\n", 
¬gv
[0]);

82 
	`ex™
(1);

85 
ho¡
 = 
¬gv
[1];

86 
pÜt
 = 
	`©oi
(
¬gv
[2]);

87 
f’ame
 = 
¬gv
[3];

90 
ş›Áfd
 = 
	`O³n_ş›Áfd
(
ho¡
, 
pÜt
);

92 
	`ş›ÁS’d
(
ş›Áfd
, 
f’ame
);

93 
	`ş›ÁPršt
(
ş›Áfd
);

95 
	`Clo£
(
ş›Áfd
);

97 
	`ex™
(0);

98 
	}
}

	@helper.c

1 
	~"h–³r.h
"

8 
	$unix_”rÜ
(*
msg
)

10 
	`årštf
(
¡d”r
, "%s: %s\n", 
msg
, 
	`¡»¼Ü
(
”ºo
));

11 
	`ex™
(0);

12 
	}
}

15 
	$posix_”rÜ
(
code
, *
msg
)

17 
	`årštf
(
¡d”r
, "%s: %s\n", 
msg
, 
	`¡»¼Ü
(
code
));

18 
	`ex™
(0);

19 
	}
}

21 
	$dns_”rÜ
(*
msg
)

23 
	`årštf
(
¡d”r
, "%s: DNSƒ¼Ü %d\n", 
msg
, 
h_”ºo
);

24 
	`ex™
(0);

25 
	}
}

27 
	$­p_”rÜ
(*
msg
)

29 
	`årštf
(
¡d”r
, "%s\n", 
msg
);

30 
	`ex™
(0);

31 
	}
}

35 
	$G‘ho¡Çme
(*
Çme
, 
size_t
 
Ën
)

37 
rc
;

39 ià((
rc
 = 
	`g‘ho¡Çme
(
Çme
, 
Ën
)) < 0)

40 
	`unix_”rÜ
("Setenvƒrror");

41  
rc
;

42 
	}
}

44 
	$S‘’v
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
ov”wr™e
)

46 
rc
;

48 ià((
rc
 = 
	`£‹nv
(
Çme
, 
v®ue
, 
ov”wr™e
)) < 0)

49 
	`unix_”rÜ
("Setenvƒrror");

50  
rc
;

51 
	}
}

58 
pid_t
 
	$FÜk
()

60 
pid_t
 
pid
;

62 ià((
pid
 = 
	`fÜk
()) < 0)

63 
	`unix_”rÜ
("Forkƒrror");

64  
pid
;

65 
	}
}

68 
	$Execve
(cÚ¡ *
f’ame
, *cÚ¡ 
¬gv
[], *cÚ¡ 
’vp
[])

70 ià(
	`execve
(
f’ame
, 
¬gv
, 
’vp
) < 0)

71 
	`unix_”rÜ
("Execveƒrror");

72 
	}
}

75 
pid_t
 
	$Wa™
(*
¡©us
)

77 
pid_t
 
pid
;

79 ià((
pid
 = 
	`wa™
(
¡©us
)) < 0)

80 
	`unix_”rÜ
("Waitƒrror");

81  
pid
;

82 
	}
}

89 
	$O³n
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
)

91 
rc
;

93 ià((
rc
 = 
	`İ’
(
·thÇme
, 
æags
, 
mode
)) < 0)

94 
	`unix_”rÜ
("Openƒrror");

95  
rc
;

96 
	}
}

98 
ssize_t
 
	$R—d
(
fd
, *
buf
, 
size_t
 
couÁ
)

100 
ssize_t
 
rc
;

102 ià((
rc
 = 
	`»ad
(
fd
, 
buf
, 
couÁ
)) < 0)

103 
	`unix_”rÜ
("Readƒrror");

104  
rc
;

105 
	}
}

107 
ssize_t
 
	$Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
)

109 
ssize_t
 
rc
;

111 ià((
rc
 = 
	`wr™e
(
fd
, 
buf
, 
couÁ
)) < 0)

112 
	`unix_”rÜ
("Writeƒrror");

113  
rc
;

114 
	}
}

116 
off_t
 
	$L£ek
(
fdes
, 
off_t
 
off£t
, 
wh’û
)

118 
off_t
 
rc
;

120 ià((
rc
 = 
	`l£ek
(
fdes
, 
off£t
, 
wh’û
)) < 0)

121 
	`unix_”rÜ
("Lseekƒrror");

122  
rc
;

123 
	}
}

125 
	$Clo£
(
fd
)

127 
rc
;

129 ià((
rc
 = 
	`şo£
(
fd
)) < 0)

130 
	`unix_”rÜ
("Closeƒrror");

131 
	}
}

133 
	$S–eù
(
n
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
,

134 
fd_£t
 *
exû±fds
, 
timev®
 *
timeout
)

136 
rc
;

138 ià((
rc
 = 
	`£Ëù
(
n
, 
»adfds
, 
wr™efds
, 
exû±fds
, 
timeout
)) < 0)

139 
	`unix_”rÜ
("Selectƒrror");

140  
rc
;

141 
	}
}

143 
	$Dup2
(
fd1
, 
fd2
)

145 
rc
;

147 ià((
rc
 = 
	`dup2
(
fd1
, 
fd2
)) < 0)

148 
	`unix_”rÜ
("Dup2ƒrror");

149  
rc
;

150 
	}
}

152 
	$St
(cÚ¡ *
f’ame
, 
¡©
 *
buf
)

154 ià(
	`¡©
(
f’ame
, 
buf
) < 0)

155 
	`unix_”rÜ
("Statƒrror");

156 
	}
}

158 
	$F¡©
(
fd
, 
¡©
 *
buf
)

160 ià(
	`f¡©
(
fd
, 
buf
) < 0)

161 
	`unix_”rÜ
("Fstatƒrror");

162 
	}
}

167 *
	$Mm­
(*
addr
, 
size_t
 
Ën
, 
´Ù
, 
æags
, 
fd
, 
off_t
 
off£t
)

169 *
±r
;

171 ià((
±r
 = 
	`mm­
(
addr
, 
Ën
, 
´Ù
, 
æags
, 
fd
, 
off£t
)) == ((*) -1))

172 
	`unix_”rÜ
("mmapƒrror");

173 (
±r
);

174 
	}
}

176 
	$Munm­
(*
¡¬t
, 
size_t
 
Ëngth
)

178 ià(
	`munm­
(
¡¬t
, 
Ëngth
) < 0)

179 
	`unix_”rÜ
("munmapƒrror");

180 
	}
}

186 
	$Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
)

188 
rc
;

190 ià((
rc
 = 
	`sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
)) < 0)

191 
	`unix_”rÜ
("Socketƒrror");

192  
rc
;

193 
	}
}

195 
	$S‘sockİt
(
s
, 
Ëv–
, 
İŠame
, cÚ¡ *
İtv®
, 
İ’
)

197 
rc
;

199 ià((
rc
 = 
	`£tsockİt
(
s
, 
Ëv–
, 
İŠame
, 
İtv®
, 
İ’
)) < 0)

200 
	`unix_”rÜ
("Setsockoptƒrror");

201 
	}
}

203 
	$Bšd
(
sockfd
, 
sockaddr
 *
my_addr
, 
add¾’
)

205 
rc
;

207 ià((
rc
 = 
	`bšd
(
sockfd
, 
my_addr
, 
add¾’
)) < 0)

208 
	`unix_”rÜ
("Bindƒrror");

209 
	}
}

211 
	$Li¡’
(
s
, 
backlog
)

213 
rc
;

215 ià((
rc
 = 
	`li¡’
(
s
, 
backlog
)) < 0)

216 
	`unix_”rÜ
("Listenƒrror");

217 
	}
}

219 
	$Acû±
(
s
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
)

221 
rc
;

223 ià((
rc
 = 
	`acû±
(
s
, 
addr
, 
add¾’
)) < 0)

224 
	`unix_”rÜ
("Acceptƒrror");

225  
rc
;

226 
	}
}

228 
	$CÚÃù
(
sockfd
, 
sockaddr
 *
£rv_addr
, 
add¾’
)

230 
rc
;

232 ià((
rc
 = 
	`cÚÃù
(
sockfd
, 
£rv_addr
, 
add¾’
)) < 0)

233 
	`unix_”rÜ
("Connectƒrror");

234 
	}
}

241 
ho¡’t
 *
	$G‘ho¡byÇme
(cÚ¡ *
Çme
)

243 
ho¡’t
 *
p
;

245 ià((
p
 = 
	`g‘ho¡byÇme
(
Çme
)è=ğ
NULL
)

246 
	`dns_”rÜ
("Gethostbynameƒrror");

247  
p
;

248 
	}
}

251 
ho¡’t
 *
	$G‘ho¡byaddr
(cÚ¡ *
addr
, 
Ën
, 
ty³
)

253 
ho¡’t
 *
p
;

255 ià((
p
 = 
	`g‘ho¡byaddr
(
addr
, 
Ën
, 
ty³
)è=ğ
NULL
)

256 
	`dns_”rÜ
("Gethostbyaddrƒrror");

257  
p
;

258 
	}
}

267 
ssize_t
 
	$rio_»adn
(
fd
, *
u¤buf
, 
size_t
 
n
)

269 
size_t
 
Æeá
 = 
n
;

270 
ssize_t
 
Ä—d
;

271 *
buå
 = 
u¤buf
;

273 
Æeá
 > 0) {

274 ià((
Ä—d
 = 
	`»ad
(
fd
, 
buå
, 
Æeá
)) < 0) {

275 ià(
”ºo
 =ğ
EINTR
)

276 
Ä—d
 = 0;

280 ià(
Ä—d
 == 0)

282 
Æeá
 -ğ
Ä—d
;

283 
buå
 +ğ
Ä—d
;

285  (
n
 - 
Æeá
);

286 
	}
}

293 
ssize_t
 
	$rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
)

295 
size_t
 
Æeá
 = 
n
;

296 
ssize_t
 
nwr™‹n
;

297 *
buå
 = 
u¤buf
;

299 
Æeá
 > 0) {

300 ià((
nwr™‹n
 = 
	`wr™e
(
fd
, 
buå
, 
Æeá
)) <= 0) {

301 ià(
”ºo
 =ğ
EINTR
)

302 
nwr™‹n
 = 0;

306 
Æeá
 -ğ
nwr™‹n
;

307 
buå
 +ğ
nwr™‹n
;

309  
n
;

310 
	}
}

323 
ssize_t
 
	$rio_»ad
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
)

325 
út
;

327 
½
->
rio_út
 <= 0) {

328 
½
->
rio_út
 = 
	`»ad
Ôp->
rio_fd
,„p->
rio_buf
,

329 (
½
->
rio_buf
));

330 ià(
½
->
rio_út
 < 0) {

331 ià(
”ºo
 !ğ
EINTR
)

334 ià(
½
->
rio_út
 == 0)

337 
½
->
rio_buåŒ
 =„p->
rio_buf
;

341 
út
 = 
n
;

342 ià(
½
->
rio_út
 < 
n
)

343 
út
 = 
½
->
rio_út
;

344 
	`memıy
(
u¤buf
, 
½
->
rio_buåŒ
, 
út
);

345 
½
->
rio_buåŒ
 +ğ
út
;

346 
½
->
rio_út
 -ğ
út
;

347  
út
;

348 
	}
}

355 
	$rio_»adš™b
(
rio_t
 *
½
, 
fd
)

357 
½
->
rio_fd
 = 
fd
;

358 
½
->
rio_út
 = 0;

359 
½
->
rio_buåŒ
 =„p->
rio_buf
;

360 
	}
}

367 
ssize_t
 
	$rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
)

369 
size_t
 
Æeá
 = 
n
;

370 
ssize_t
 
Ä—d
;

371 *
buå
 = 
u¤buf
;

373 
Æeá
 > 0) {

374 ià((
Ä—d
 = 
	`rio_»ad
(
½
, 
buå
, 
Æeá
)) < 0) {

375 ià(
”ºo
 =ğ
EINTR
)

376 
Ä—d
 = 0;

380 ià(
Ä—d
 == 0)

382 
Æeá
 -ğ
Ä—d
;

383 
buå
 +ğ
Ä—d
;

385  (
n
 - 
Æeá
);

386 
	}
}

393 
ssize_t
 
	$rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
)

395 
n
, 
rc
;

396 
c
, *
buå
 = 
u¤buf
;

398 
n
 = 1;‚ < 
maxËn
;‚++) {

399 ià((
rc
 = 
	`rio_»ad
(
½
, &
c
, 1)) == 1) {

400 *
buå
++ = 
c
;

401 ià(
c
 == '\n')

403 } ià(
rc
 == 0) {

404 ià(
n
 == 1)

411 *
buå
 = 0;

412  
n
;

413 
	}
}

419 
ssize_t
 
	$Rio_»adn
(
fd
, *
±r
, 
size_t
 
nby‹s
)

421 
ssize_t
 
n
;

423 ià((
n
 = 
	`rio_»adn
(
fd
, 
±r
, 
nby‹s
)) < 0)

424 
	`unix_”rÜ
("Rio_readnƒrror");

425  
n
;

426 
	}
}

428 
	$Rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
)

430 ià(
	`rio_wr™’
(
fd
, 
u¤buf
, 
n
) !=‚)

431 
	`unix_”rÜ
("Rio_writenƒrror");

432 
	}
}

434 
	$Rio_»adš™b
(
rio_t
 *
½
, 
fd
)

436 
	`rio_»adš™b
(
½
, 
fd
);

437 
	}
}

439 
ssize_t
 
	$Rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
)

441 
ssize_t
 
rc
;

443 ià((
rc
 = 
	`rio_»adnb
(
½
, 
u¤buf
, 
n
)) < 0)

444 
	`unix_”rÜ
("Rio_readnbƒrror");

445  
rc
;

446 
	}
}

448 
ssize_t
 
	$Rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
)

450 
ssize_t
 
rc
;

452 ià((
rc
 = 
	`rio_»adlšeb
(
½
, 
u¤buf
, 
maxËn
)) < 0)

453 
	`unix_”rÜ
("Rio_readlinebƒrror");

454  
rc
;

455 
	}
}

467 
	$İ’_ş›Áfd
(*
ho¡Çme
, 
pÜt
)

469 
ş›Áfd
;

470 
ho¡’t
 *
hp
;

471 
sockaddr_š
 
£rv”addr
;

473 ià((
ş›Áfd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)) < 0)

477 ià((
hp
 = 
	`g‘ho¡byÇme
(
ho¡Çme
)è=ğ
NULL
)

479 
	`bz”o
((*è&
£rv”addr
, (serveraddr));

480 
£rv”addr
.
sš_çmy
 = 
AF_INET
;

481 
	`bcİy
((*)
hp
->
h_addr
,

482 (*)&
£rv”addr
.
sš_addr
.
s_addr
, 
hp
->
h_Ëngth
);

483 
£rv”addr
.
sš_pÜt
 = 
	`htÚs
(
pÜt
);

486 ià(
	`cÚÃù
(
ş›Áfd
, (
SA
 *è&
£rv”addr
, (serveraddr)) < 0)

488  
ş›Áfd
;

489 
	}
}

497 
	$İ’_li¡’fd
(
pÜt
)

499 
li¡’fd
, 
İtv®
=1;

500 
sockaddr_š
 
£rv”addr
;

503 ià((
li¡’fd
 = 
	`sock‘
(
AF_INET
, 
SOCK_STREAM
, 0)) < 0) {

504 
	`årštf
(
¡d”r
, "socket failed\n");

509 ià(
	`£tsockİt
(
li¡’fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
,

510 (cÚ¡ *)&
İtv®
 , ()) < 0) {

511 
	`årštf
(
¡d”r
, "setsockopt failed\n");

517 
	`bz”o
((*è&
£rv”addr
, (serveraddr));

518 
£rv”addr
.
sš_çmy
 = 
AF_INET
;

519 
£rv”addr
.
sš_addr
.
s_addr
 = 
	`htÚl
(
INADDR_ANY
);

520 
£rv”addr
.
sš_pÜt
 = 
	`htÚs
(()
pÜt
);

521 ià(
	`bšd
(
li¡’fd
, (
SA
 *)&
£rv”addr
, (serveraddr)) < 0) {

522 
	`årštf
(
¡d”r
, "bind failed\n");

527 ià(
	`li¡’
(
li¡’fd
, 
LISTENQ
) < 0) {

528 
	`årštf
(
¡d”r
, "listen failed\n");

531  
li¡’fd
;

532 
	}
}

538 
	$O³n_ş›Áfd
(*
ho¡Çme
, 
pÜt
)

540 
rc
;

542 ià((
rc
 = 
	`İ’_ş›Áfd
(
ho¡Çme
, 
pÜt
)) < 0) {

543 ià(
rc
 == -1)

544 
	`unix_”rÜ
("Open_clientfd Unixƒrror");

546 
	`dns_”rÜ
("Open_clientfd DNSƒrror");

548  
rc
;

549 
	}
}

551 
	$O³n_li¡’fd
(
pÜt
)

553 
rc
;

555 ià((
rc
 = 
	`İ’_li¡’fd
(
pÜt
)) < 0)

556 
	`unix_”rÜ
("Open_listenfdƒrror");

557  
rc
;

558 
	}
}

	@helper.h

1 #iâdeà
__HELPER_H__


2 
	#__HELPER_H__


	)

4 
	~<¡dio.h
>

5 
	~<¡dlib.h
>

6 
	~<uni¡d.h
>

7 
	~<¡ršg.h
>

8 
	~<¡ršgs.h
>

9 
	~<ùy³.h
>

10 
	~<£tjmp.h
>

11 
	~<sigÇl.h
>

12 
	~<sys/time.h
>

13 
	~<sys/ty³s.h
>

14 
	~<sys/wa™.h
>

15 
	~<sys/¡©.h
>

16 
	~<fú.h
>

17 
	~<sys/mmª.h
>

18 
	~<”ºo.h
>

19 
	~<m©h.h
>

20 
	~<±h»ad.h
>

21 
	~<£m­hÜe.h
>

22 
	~<sys/sock‘.h
>

23 
	~<Ãtdb.h
>

24 
	~<Ãtš‘/š.h
>

25 
	~<¬·/š‘.h
>

30 
	#DEF_MODE
 
S_IRUSR
|
S_IWUSR
|
S_IRGRP
|
S_IWGRP
|
S_IROTH
|
S_IWOTH


	)

31 
	#DEF_UMASK
 
S_IWGRP
|
S_IWOTH


	)

36 
sockaddr
 
	tSA
;

41 
	#RIO_BUFSIZE
 8192

	)

43 
	mrio_fd
;

44 
	mrio_út
;

45 *
	mrio_buåŒ
;

46 
	mrio_buf
[
RIO_BUFSIZE
];

47 } 
	trio_t
;

51 
h_”ºo
;

52 **
’vœÚ
;

55 
	#MAXLINE
 8192

	)

56 
	#MAXBUF
 8192

	)

57 
	#LISTENQ
 1024

	)

60 
unix_”rÜ
(*
msg
);

61 
posix_”rÜ
(
code
, *
msg
);

62 
dns_”rÜ
(*
msg
);

63 
­p_”rÜ
(*
msg
);

67 
pid_t
 
FÜk
();

68 
Execve
(cÚ¡ *
f’ame
, *cÚ¡ 
¬gv
[], *cÚ¡ 
’vp
[]);

69 
pid_t
 
Wa™
(*
¡©us
);

71 
G‘ho¡Çme
(*
Çme
, 
size_t
 
Ën
) ;

72 
S‘’v
(cÚ¡ *
Çme
, cÚ¡ *
v®ue
, 
ov”wr™e
);

75 
O³n
(cÚ¡ *
·thÇme
, 
æags
, 
mode_t
 
mode
);

76 
ssize_t
 
R—d
(
fd
, *
buf
, 
size_t
 
couÁ
);

77 
ssize_t
 
Wr™e
(
fd
, cÚ¡ *
buf
, 
size_t
 
couÁ
);

78 
off_t
 
L£ek
(
fdes
, off_ˆ
off£t
, 
wh’û
);

79 
Clo£
(
fd
);

80 
S–eù
(
n
, 
fd_£t
 *
»adfds
, fd_£ˆ*
wr™efds
, fd_£ˆ*
exû±fds
,

81 
timev®
 *
timeout
);

82 
Dup2
(
fd1
, 
fd2
);

83 
St
(cÚ¡ *
f’ame
, 
¡©
 *
buf
);

84 
F¡©
(
fd
, 
¡©
 *
buf
) ;

87 *
Mm­
(*
addr
, 
size_t
 
Ën
, 
´Ù
, 
æags
, 
fd
, 
off_t
 
off£t
);

88 
Munm­
(*
¡¬t
, 
size_t
 
Ëngth
);

91 
Sock‘
(
domaš
, 
ty³
, 
´ÙocŞ
);

92 
S‘sockİt
(
s
, 
Ëv–
, 
İŠame
, cÚ¡ *
İtv®
, 
İ’
);

93 
Bšd
(
sockfd
, 
sockaddr
 *
my_addr
, 
add¾’
);

94 
Li¡’
(
s
, 
backlog
);

95 
Acû±
(
s
, 
sockaddr
 *
addr
, 
sockËn_t
 *
add¾’
);

96 
CÚÃù
(
sockfd
, 
sockaddr
 *
£rv_addr
, 
add¾’
);

99 
ho¡’t
 *
G‘ho¡byÇme
(cÚ¡ *
Çme
);

100 
ho¡’t
 *
G‘ho¡byaddr
(cÚ¡ *
addr
, 
Ën
, 
ty³
);

103 
ssize_t
 
rio_»adn
(
fd
, *
u¤buf
, 
size_t
 
n
);

104 
ssize_t
 
rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
);

105 
rio_»adš™b
(
rio_t
 *
½
, 
fd
);

106 
ssize_t
 
rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
);

107 
ssize_t
 
rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
);

110 
ssize_t
 
Rio_»adn
(
fd
, *
u¤buf
, 
size_t
 
n
);

111 
Rio_wr™’
(
fd
, *
u¤buf
, 
size_t
 
n
);

112 
Rio_»adš™b
(
rio_t
 *
½
, 
fd
);

113 
ssize_t
 
Rio_»adnb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
n
);

114 
ssize_t
 
Rio_»adlšeb
(
rio_t
 *
½
, *
u¤buf
, 
size_t
 
maxËn
);

117 
İ’_ş›Áfd
(*
ho¡Çme
, 
pÜŠo
);

118 
İ’_li¡’fd
(
pÜŠo
);

121 
O³n_ş›Áfd
(*
ho¡Çme
, 
pÜt
);

122 
O³n_li¡’fd
(
pÜt
);

	@output.c

1 
	~"h–³r.h
"

2 
	~<sys/time.h
>

3 
	~<as£¹.h
>

4 
	~<uni¡d.h
>

13 
	g¥šfÜ
 = 5.0;

15 
	$g‘¬gs
()

17 *
buf
, *
p
;

20 ià((
buf
 = 
	`g‘’v
("QUERY_STRING")è!ğ
NULL
) {

21 
p
 = 
	`¡¹ok
(
buf
, "&");

22 ià(
p
 =ğ
NULL
)

24 
¥šfÜ
 = (è
	`©oi
(
p
);

27 
	}
}

29 
	$Time_G‘SecÚds
() {

30 
timev®
 
t
;

31 
rc
 = 
	`g‘timeofday
(&
t
, 
NULL
);

32 
	`as£¹
(
rc
 == 0);

33  (è(()
t
.
tv_£c
 + (é.
tv_u£c
 / 1e6);

34 
	}
}

37 
	$maš
(
¬gc
, *
¬gv
[])

39 
cÚ‹Á
[
MAXBUF
];

41 
	`g‘¬gs
();

43 
t1
 = 
	`Time_G‘SecÚds
();

44 (
	`Time_G‘SecÚds
(è- 
t1
è< 
¥šfÜ
)

45 
	`¦“p
(1);

46 
t2
 = 
	`Time_G‘SecÚds
();

49 
	`¥rštf
(
cÚ‹Á
, "<p>Welcomeohe CGI…rogram</p>\r\n");

50 
	`¥rštf
(
cÚ‹Á
, "%s<p>My only…urpose iso wasteime onhe server!</p>\r\n", content);

51 
	`¥rštf
(
cÚ‹Á
, "%s<p>I spuÀfÜ %.2à£cÚds</p>\r\n", cÚ‹Á, 
t2
 - 
t1
);

54 
	`´štf
("CÚ‹Á-Ëngth: %lu\r\n", 
	`¡¾’
(
cÚ‹Á
));

55 
	`´štf
("Content-type:ext/html\r\n\r\n");

56 
	`´štf
("%s", 
cÚ‹Á
);

57 
	`fæush
(
¡dout
);

59 
	`ex™
(0);

60 
	}
}

	@request.c

5 
	~"h–³r.h
"

6 
	~"»que¡.h
"

9 
	$»que¡E¼Ü
(
fd
, *
ÿu£
, *
”ºum
, *
shÜtmsg
, *
lÚgmsg
)

11 
buf
[
MAXLINE
], 
body
[
MAXBUF
];

14 
	`¥rštf
(
body
, "<html><title>CS537 Error</title>");

15 
	`¥rštf
(
body
, "%s<body bgcolor=\"fffff\">\r\n", body);

16 
	`¥rštf
(
body
, "%s%s: %s\r\n", body, 
”ºum
, 
shÜtmsg
);

17 
	`¥rštf
(
body
, "%s<p>%s: %s\r\n", body, 
lÚgmsg
, 
ÿu£
);

18 
	`¥rštf
(
body
, "%s<hr>CS537 Web Server\r\n", body);

21 
	`¥rštf
(
buf
, "HTTP/1.0 % %s\r\n", 
”ºum
, 
shÜtmsg
);

22 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

23 
	`´štf
("%s", 
buf
);

25 
	`¥rštf
(
buf
, "Content-Type:ext/html\r\n");

26 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

27 
	`´štf
("%s", 
buf
);

29 
	`¥rštf
(
buf
, "CÚ‹Á-L’gth: %lu\r\n\r\n", 
	`¡¾’
(
body
));

30 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

31 
	`´štf
("%s", 
buf
);

34 
	`Rio_wr™’
(
fd
, 
body
, 
	`¡¾’
(body));

35 
	`´štf
("%s", 
body
);

36 
	}
}

42 
	$»que¡R—dhdrs
(
rio_t
 *
½
)

44 
buf
[
MAXLINE
];

46 
	`Rio_»adlšeb
(
½
, 
buf
, 
MAXLINE
);

47 
	`¡rcmp
(
buf
, "\r\n")) {

48 
	`Rio_»adlšeb
(
½
, 
buf
, 
MAXLINE
);

51 
	}
}

57 
	$»que¡P¬£URI
(*
uri
, *
f’ame
, *
cgŸrgs
)

59 *
±r
;

61 ià(!
	`¡r¡r
(
uri
, "cgi")) {

63 
	`¡rıy
(
cgŸrgs
, "");

64 
	`¥rštf
(
f’ame
, ".%s", 
uri
);

65 ià(
uri
[
	`¡¾’
(uri)-1] == '/') {

66 
	`¡rÿt
(
f’ame
, "home.html");

71 
±r
 = 
	`šdex
(
uri
, '?');

72 ià(
±r
) {

73 
	`¡rıy
(
cgŸrgs
, 
±r
+1);

74 *
±r
 = '\0';

76 
	`¡rıy
(
cgŸrgs
, "");

78 
	`¥rštf
(
f’ame
, ".%s", 
uri
);

81 
	}
}

86 
	$»que¡G‘F‘y³
(*
f’ame
, *
f‘y³
)

88 ià(
	`¡r¡r
(
f’ame
, ".html"))

89 
	`¡rıy
(
f‘y³
, "text/html");

90 ià(
	`¡r¡r
(
f’ame
, ".gif"))

91 
	`¡rıy
(
f‘y³
, "image/gif");

92 ià(
	`¡r¡r
(
f’ame
, ".jpg"))

93 
	`¡rıy
(
f‘y³
, "image/jpeg");

95 
	`¡rıy
(
f‘y³
, "text/plain");

96 
	}
}

98 
	$»que¡S”veDyÇmic
(
fd
, *
f’ame
, *
cgŸrgs
)

100 
buf
[
MAXLINE
], *
em±yli¡
[] = {
NULL
};

104 
	`¥rštf
(
buf
, "HTTP/1.0 200 OK\r\n");

105 
	`¥rštf
(
buf
, "%sServer: CS537 Web Server\r\n", buf);

107 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

109 ià(
	`FÜk
() == 0) {

111 
	`S‘’v
("QUERY_STRING", 
cgŸrgs
, 1);

113 
	`Dup2
(
fd
, 
STDOUT_FILENO
);

114 
	`Execve
(
f’ame
, 
em±yli¡
, 
’vœÚ
);

116 
	`Wa™
(
NULL
);

117 
	}
}

120 
	$»que¡S”veStic
(
fd
, *
f’ame
, 
fesize
)

122 
¤cfd
;

123 *
¤ı
, 
f‘y³
[
MAXLINE
], 
buf
[
MAXBUF
];

125 
	`»que¡G‘F‘y³
(
f’ame
, 
f‘y³
);

127 
¤cfd
 = 
	`O³n
(
f’ame
, 
O_RDONLY
, 0);

131 
¤ı
 = 
	`Mm­
(0, 
fesize
, 
PROT_READ
, 
MAP_PRIVATE
, 
¤cfd
, 0);

132 
	`Clo£
(
¤cfd
);

135 
	`¥rštf
(
buf
, "HTTP/1.0 200 OK\r\n");

136 
	`¥rštf
(
buf
, "%sServer: CS537 Web Server\r\n", buf);

137 
	`¥rštf
(
buf
, "%sCÚ‹Á-L’gth: %d\r\n", buf, 
fesize
);

138 
	`¥rštf
(
buf
, "%sCÚ‹Á-Ty³: %s\r\n\r\n", buf, 
f‘y³
);

140 
	`Rio_wr™’
(
fd
, 
buf
, 
	`¡¾’
(buf));

143 
	`Rio_wr™’
(
fd
, 
¤ı
, 
fesize
);

144 
	`Munm­
(
¤ı
, 
fesize
);

146 
	}
}

149 
	$»que¡HªdË
(
fd
)

152 
is_¡©ic
;

153 
¡©
 
sbuf
;

154 
buf
[
MAXLINE
], 
m‘hod
[MAXLINE], 
uri
[MAXLINE], 
v”siÚ
[MAXLINE];

155 
f’ame
[
MAXLINE
], 
cgŸrgs
[MAXLINE];

156 
rio_t
 
rio
;

158 
	`Rio_»adš™b
(&
rio
, 
fd
);

159 
	`Rio_»adlšeb
(&
rio
, 
buf
, 
MAXLINE
);

160 
	`ssÿnf
(
buf
, "% % %s", 
m‘hod
, 
uri
, 
v”siÚ
);

162 
	`´štf
("% % %s\n", 
m‘hod
, 
uri
, 
v”siÚ
);

164 ià(
	`¡rÿ£cmp
(
m‘hod
, "GET")) {

165 
	`»que¡E¼Ü
(
fd
, 
m‘hod
, "501", "Not Implemented", "CS537 Server does‚ot implementhis method");

168 
	`»que¡R—dhdrs
(&
rio
);

170 
is_¡©ic
 = 
	`»que¡P¬£URI
(
uri
, 
f’ame
, 
cgŸrgs
);

171 ià(
	`¡©
(
f’ame
, &
sbuf
) < 0) {

172 
	`»que¡E¼Ü
(
fd
, 
f’ame
, "404", "Not found", "CS537 Server could‚ot findhis file");

176 ià(
is_¡©ic
) {

177 ià(!(
	`S_ISREG
(
sbuf
.
¡_mode
)è|| !(
S_IRUSR
 & sbuf.st_mode)) {

178 
	`»que¡E¼Ü
(
fd
, 
f’ame
, "403", "Forbidden", "CS537 Server could‚ot„eadhis file");

181 
	`»que¡S”veStic
(
fd
, 
f’ame
, 
sbuf
.
¡_size
);

188 ià(!(
	`S_ISREG
(
sbuf
.
¡_mode
)è|| !(
S_IXUSR
 & sbuf.st_mode)) {

189 
	`»que¡E¼Ü
(
fd
, 
f’ame
, "403", "Forbidden", "CS537 Server could‚ot„unhis CGI…rogram");

192 
	`»que¡S”veDyÇmic
(
fd
, 
f’ame
, 
cgŸrgs
);

199 
	}
}

	@request.h

1 #iâdeà
__REQUEST_H__


3 
»que¡HªdË
(
fd
);

	@server.c

1 
	~"h–³r.h
"

2 
	~"»que¡.h
"

15 
	$g‘¬gs
(*
pÜt
, 
¬gc
, *
¬gv
[])

17 ià(
¬gc
 != 2) {

18 
	`årštf
(
¡d”r
, "U§ge: % <pÜt>\n", 
¬gv
[0]);

19 
	`ex™
(1);

21 *
pÜt
 = 
	`©oi
(
¬gv
[1]);

22 
	}
}

25 
	$maš
(
¬gc
, *
¬gv
[])

27 
li¡’fd
, 
cÚnfd
, 
pÜt
, 
ş›ÁËn
;

28 
sockaddr_š
 
ş›Áaddr
;

30 
	`g‘¬gs
(&
pÜt
, 
¬gc
, 
¬gv
);

40 
li¡’fd
 = 
	`O³n_li¡’fd
(
pÜt
);

42 
ş›ÁËn
 = (
ş›Áaddr
);

43 
cÚnfd
 = 
	`Acû±
(
li¡’fd
, (
SA
 *)&
ş›Áaddr
, (
sockËn_t
 *è&
ş›ÁËn
);

50 
	`»que¡HªdË
(
cÚnfd
);

51 
	`Clo£
(
cÚnfd
);

53 
	}
}

	@
1
.
0
7
65
client.c
helper.c
helper.h
output.c
request.c
request.h
server.c
